<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sender</title>
  <style>
    body { background:#000; color:#0f0; font-family:monospace; text-align:center; }
    video { width:100%; border:2px solid #0f0; margin-top:10px; }
    button { background:#0f0; color:#000; padding:10px; border:none; cursor:pointer; }
    #logBox {
      position:fixed; bottom:0; left:0; width:100%; max-height:50%;
      overflow-y:auto; background:rgba(0,0,0,0.85); border-top:2px solid #0f0;
      font-size:13px; text-align:left; padding:6px;
    }
    .logEntry { margin:2px 0; border-bottom:1px dashed #0f0; padding-bottom:2px; }
  </style>
</head>
<body>
  <h2>📡 Screen Sender</h2>
  <button id="startBtn">Share Screen</button>
  <video id="preview" autoplay playsinline></video>
  <div id="logBox"></div>

  <script>
    const logBox = document.getElementById("logBox");
    function log(msg) {
      const line = document.createElement("div");
      line.className = "logEntry";
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(line);
      logBox.scrollTop = logBox.scrollHeight;
    }

    const socket = new WebSocket("wss://prototypes-le04.onrender.com");
    const video = document.getElementById("preview");
    const startBtn = document.getElementById("startBtn");

    socket.onopen = () => log("Connected to signaling server ✅");
    socket.onerror = e => log("WebSocket error: " + e.message);
    socket.onclose = () => log("WebSocket closed ❌");

    let peer;

    socket.onmessage = async e => {
      const data = JSON.parse(e.data);
      log("Received: " + Object.keys(data).join(", "));
      if (peer && data.answer) {
        await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
        log("Remote answer applied");
      } else if (peer && data.candidate) {
        await peer.addIceCandidate(new RTCIceCandidate(data.candidate));
        log("Remote ICE candidate added");
      }
    };

    startBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
        video.srcObject = stream;
        log("Display stream captured");

        peer = new RTCPeerConnection();
        stream.getTracks().forEach(track => peer.addTrack(track, stream));
        peer.onicecandidate = e => {
          if (e.candidate) {
            socket.send(JSON.stringify({ candidate:e.candidate }));
            log("Sent local ICE candidate");
          }
        };

        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        socket.send(JSON.stringify({ offer }));
        log("Offer sent to signaling server");
      } catch (err) {
        log("Error: " + err.message);
      }
    };
  </script>
</body>
</html>
