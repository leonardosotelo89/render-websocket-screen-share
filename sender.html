<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sender</title>
</head>
<body style="background:black;color:lime;">
<button id="start">Start Share</button>

<script>
const ws = new WebSocket("ws://localhost:8080");   // CAMBIAR si es remoto
ws.binaryType = "arraybuffer";

let video, canvas, ctx;
let last = 0;
const FPS = 12;   // ajustable

document.getElementById("start").onclick = async () => {
  const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });

  video = document.createElement("video");
  video.srcObject = stream;
  await video.play();

  canvas = document.createElement("canvas");
  ctx = canvas.getContext("2d");

  requestAnimationFrame(loop);
};

async function loop(t) {
  if (t - last >= 1000 / FPS) {
    last = t;

    // preparar canvas
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    ctx.drawImage(video, 0, 0);

    // en lugar de base64 → BLOB → ArrayBuffer → WebSocket binario
    canvas.toBlob(async (blob) => {
      if (!blob) return;
      if (ws.readyState !== WebSocket.OPEN) return;

      // control básico de atasco
      if (ws.bufferedAmount < 2_000_000) {
        ws.send(await blob.arrayBuffer());
      }
    }, "image/webp", 0.60); // calidad ajustable
  }

  requestAnimationFrame(loop);
}
</script>
</body>
</html>

